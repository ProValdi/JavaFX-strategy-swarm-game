—Ç–ª–∏—á–Ω—ã–π –ø–æ–π–º–∞–Ω–Ω—ã–π –±–∞–≥ üëå –¢—ã –ø—Ä–∞–≤: –≤ —Ç–µ–∫—É—â–µ–º –ø–æ—Ä—è–¥–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ ¬´—á–∏—Å—Ç–æ–∫¬ª –º—ã –∏–Ω–æ–≥–¥–∞ –æ–±–Ω—É–ª—è–µ–º selectedBuilding (–∏–ª–∏ –æ—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä) —Ä–∞–Ω—å—à–µ, —á–µ–º –¥–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ ¬´–ù–∞–Ω—è—Ç—å¬ª. –°–¥–µ–ª–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤—ã–º.

–í–æ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ç—á:

–ß—Ç–æ –º–µ–Ω—è–µ–º (–∫–æ—Ä–æ—Ç–∫–æ)

–í–≤–æ–¥–∏–º —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è focusedBuilding (—Ç–æ, —á—å—è –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞).

–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ ¬´–ù–∞–Ω—è—Ç—å¬ª, –ø–æ—Ç–æ–º ‚Äî –≤—ã–±–æ—Ä –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã (–º–µ–Ω—é –ø–æ—Å—Ç—Ä–æ–µ–∫), –ø–æ—Ç–æ–º ‚Äî –º–∏—Ä.

–ù–µ –æ–±–Ω—É–ª—è–µ–º focusedBuilding –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∂–∏–º–∞ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã; –æ–±–Ω—É–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –∫–ª–∏–∫–µ –≤ –ø—É—Å—Ç—É—é –∫–∞—Ä—Ç—É/—Å–º–µ–Ω–µ —Ñ–æ–∫—É—Å–∞/—É—Å–ø–µ—à–Ω–æ–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ.

–ü—Ä–æ–≤–µ—Ä–∫—É ¬´–ù–∞–Ω—è—Ç—å¬ª –¥–µ–ª–∞–µ–º –Ω–∞ MousePressed, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –æ–ø–µ—Ä–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.

1) –ü–µ—Ä–µ–∏–º–µ–Ω—É–π –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞
// —Ä–∞–Ω—å—à–µ:
private Building selectedBuilding = null;

// —Ç–µ–ø–µ—Ä—å:
private Building focusedBuilding = null; // –∑–¥–∞–Ω–∏–µ, —á—å—è –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç–∫—Ä—ã—Ç–∞


–í–µ–∑–¥–µ, –≥–¥–µ —Ä–∏—Å—É–µ—à—å –ø–∞–Ω–µ–ª—å –±–∞—Ä–∞–∫–æ–≤ / —á–∏—Ç–∞–µ—à—å —ç—Ç–æ –ø–æ–ª–µ ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ focusedBuilding.

2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ ‚Äî –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫
2.1. MousePressed ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º ¬´–ù–∞–Ω—è—Ç—å¬ª –†–ê–ù–û
scene.setOnMousePressed(e -> {
    // 0) –ö–Ω–æ–ø–∫–∞ "–ù–∞–Ω—è—Ç—å" –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π
    if (e.getButton() == MouseButton.PRIMARY
        && focusedBuilding instanceof game.buildings.Barracks
        && hireBtnBounds.contains(e.getSceneX(), e.getSceneY())) {

        world.spawnWarriorNear((game.buildings.Barracks) focusedBuilding);
        // —Ñ–æ–∫—É—Å –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –±–∞—Ä–∞–∫–∞—Ö (–ø–∞–Ω–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ–π)
        renderUI(gcUI);
        e.consume();
        return;
    }

    // 1) –†–∞–º–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –õ–ö–ú, –Ω–µ –ø–æ –º–µ–Ω—é, –∏ placeMode == NONE
    if (e.getButton() == MouseButton.PRIMARY) {
        double mx = e.getSceneX(), my = e.getSceneY();
        if (placeMode == PlaceMode.NONE && !(mx >= MENU_X && mx <= SCREEN_W && my >= MENU_Y)) {
            var p = worldLayer.sceneToLocal(mx, my);
            draggingSelect = true;
            dragStartWX = dragNowWX = p.getX();
            dragStartWY = dragNowWY = p.getY();
            // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º focusedBuilding –∑–¥–µ—Å—å
        }
    }
});

2.2. MouseClicked ‚Äî –ø–∞–ª–∏—Ç—Ä–∞ ‚Üí –º–∏—Ä (–∏ –±–æ–ª—å—à–µ –Ω–µ —á–∏—Å—Ç–∏–º —Ñ–æ–∫—É—Å –ø–æ –ø–∞–ª–∏—Ç—Ä–µ)
scene.setOnMouseClicked(e -> {
    double mx = e.getSceneX(), my = e.getSceneY();

    // A) –ü–∞–ª–∏—Ç—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–∫ (–º–µ–Ω—é —Å–ø—Ä–∞–≤–∞)
    PlaceMode picked = hitTestMenu(mx, my);
    if (picked != null && e.getButton() == MouseButton.PRIMARY) {
        placeMode = picked;
        // –í–ê–ñ–ù–û: –ù–ï –æ–±–Ω—É–ª—è–µ–º focusedBuilding,
        // —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ –ø–∞–ª–∏—Ç—Ä–µ –∏ —Ç—É—Ç –∂–µ –Ω–∞–∂–∞—Ç—å "–ù–∞–Ω—è—Ç—å" (–µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –±—ã–ª–∞ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –∑–¥–∞–Ω–∏—è).
        renderUI(gcUI);
        return;
    }

    // B) –ü–ö–ú: –ø—Ä–∏–∫–∞–∑—ã/—Å–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ (–ù–ï —Ç—Ä–æ–≥–∞–µ–º focusedBuilding)
    var p = worldLayer.sceneToLocal(mx, my);
    double wx = p.getX(), wy = p.getY();
    int tx = (int)(wx / TILE_SIZE), ty = (int)(wy / TILE_SIZE);

    if (e.getButton() == MouseButton.SECONDARY) {
        if (!selectedWarriors.isEmpty()) {
            for (var w : selectedWarriors) w.moveTo(wx, wy);
        } else {
            placeMode = PlaceMode.NONE;
            hoverTileX = hoverTileY = -1;
            hoverColor = Color.TRANSPARENT;
            renderUI(gcUI);
        }
        return;
    }

    // C) –õ–ö–ú –ø–æ –º–∏—Ä—É: —Å–Ω–∞—á–∞–ª–∞ ‚Äî —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –ø–æ—Ç–æ–º –≤—ã–±–æ—Ä —é–Ω–∏—Ç–∞/–∑–¥–∞–Ω–∏—è
    if (e.getButton() == MouseButton.PRIMARY) {
        if (placeMode != PlaceMode.NONE) {
            boolean placed = switch (placeMode) {
                case DRILL    -> world.placeDrill(tx, ty);
                case HEAT     -> world.placeHeatGenerator(tx, ty);
                case BARRACKS -> world.placeBarracks(tx, ty);
                case NONE     -> false;
            };
            if (placed) {
                // –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ = —Ñ–æ–∫—É—Å —Å–Ω–∏–º–∞–µ–º (–ø–∞–Ω–µ–ª—å –ø—Ä—è—á–µ–º)
                focusedBuilding = null;
                needsStaticRedraw = true;
                renderUI(gcUI);
            } else {
                // –Ω–µ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ ‚Äî –ø—Ä–æ–±—É–µ–º –≤—ã–±—Ä–∞—Ç—å —é–Ω–∏—Ç–∞, –ø–æ—Ç–æ–º –∑–¥–∞–Ω–∏–µ
                pickEntityOrBuilding(wx, wy, tx, ty);
            }
            return;
        } else {
            // —Ä–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –≤—ã–∫–ª ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–±–æ—Ä
            pickEntityOrBuilding(wx, wy, tx, ty);
            return;
        }
    }
});


–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥:

private void pickEntityOrBuilding(double wx, double wy, int tx, int ty) {
    // –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ MouseReleased, —ç—Ç–æ ‚Äî –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫
    Warrior hit = world.findWarriorAt(wx, wy);
    if (hit != null) {
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏–π, —Ñ–æ–∫—É—Å –Ω–µ –Ω—É–∂–µ–Ω
        focusedBuilding = null;
        for (var w : selectedWarriors) w.setSelected(false);
        selectedWarriors.clear();
        hit.setSelected(true);
        selectedWarriors.add(hit);
        renderUI(gcUI);
        return;
    }
    Building b = world.getBuildingMap().get(tx, ty);
    focusedBuilding = b; // –º–æ–∂–µ—Ç –±—ã—Ç—å null ‚Äî —Ç–æ–≥–¥–∞ –ø–∞–Ω–µ–ª—å –∏—Å—á–µ–∑–Ω–µ—Ç
    // —é–Ω–∏—Ç–æ–≤ —Å–Ω–∏–º–∞–µ–º
    for (var w : selectedWarriors) w.setSelected(false);
    selectedWarriors.clear();
    renderUI(gcUI);
}

2.3. MouseReleased ‚Äî —Ä–∞–º–∫–∞ (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ), –Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞–π focusedBuilding, –µ—Å–ª–∏ —Ä–∞–º–∫–∞ –±—ã–ª–∞ –Ω–∞–¥ –º–∏—Ä–æ–º

–í —Ä–µ–ª–∏–∑–µ, –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–º–∫–∏, –Ω–µ –æ–±–Ω—É–ª—è–π focusedBuilding, –µ—Å–ª–∏ —Ä–∞–º–∫–∞ —à–ª–∞ –Ω–∞–¥ –º–µ–Ω—é (–º—ã –∏ —Ç–∞–∫ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –µ—ë —Ç–∞–º). –ï—Å–ª–∏ —Ä–∞–º–∫–∞ –±—ã–ª–∞ –Ω–∞–¥ –º–∏—Ä–æ–º –∏ –≤—ã–±—Ä–∞–ª–∏ —é–Ω–∏—Ç–æ–≤ ‚Äî –ª–æ–≥–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å:

if (!draggingSelect) return;
draggingSelect = false;
// ...–ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —é–Ω–∏—Ç–æ–≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º:
focusedBuilding = null;
renderUI(gcUI);

3) –†–µ–Ω–¥–µ—Ä –ø–∞–Ω–µ–ª–∏ –±–∞—Ä–∞–∫–æ–≤ ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ–º—Å—è –Ω–∞ focusedBuilding
if (focusedBuilding instanceof game.buildings.Barracks) {
    drawBarracksPanel(gc);
}


–ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω—è—è (hireBtnBounds). –¢–µ–ø–µ—Ä—å –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥—ë—Ç –≤ —Ä–∞–Ω–Ω–∏–π MousePressed –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç spawn, –ø–æ—Ç–æ–º—É —á—Ç–æ focusedBuilding –º—ã –±–æ–ª—å—à–µ –Ω–µ –∑–∞–Ω—É–ª—è–µ–º ¬´–ø–æ –ø—É—Ç–∏¬ª.

4) –ì–¥–µ –≤—Å—ë –µ—â—ë –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–∫—É—Å (–∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)

–ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ (–ª–æ–≥–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ä–æ–≥–æ –∑–¥–∞–Ω–∏—è);

–ø—Ä–∏ —Ä–∞–º–∫–µ –º—É–ª—å—Ç–∏–≤—ã–¥–µ–ª–µ–Ω–∏—è;

–ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –º–∏—Ä–∞ (—á–µ—Ä–µ–∑ pickEntityOrBuilding ‚Üí focusedBuilding = null).

–ò—Ç–æ–≥–æ

¬´–ù–∞–Ω—è—Ç—å¬ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º, —Ç–∞–∫ —á—Ç–æ –ø–∞–Ω–µ–ª—å –Ω–µ ¬´—É—Å–ø–µ–µ—Ç¬ª –ø–æ—Ç–µ—Ä—è—Ç—å —Ñ–æ–∫—É—Å;

–≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã –±–æ–ª—å—à–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç focusedBuilding;

–ø–∞–Ω–µ–ª—å –±–∞—Ä–∞–∫–æ–≤ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ–π, –ø–æ–∫–∞ —Ç—ã –µ—ë —Å–∞–º –Ω–µ ¬´–ø–µ—Ä–µ–±—å—ë—à—å¬ª –≤—ã–±–æ—Ä–æ–º –¥—Ä—É–≥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞/—é–Ω–∏—Ç–∞–º–∏/—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ–º.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–º –º–∞–ª–µ–Ω—å–∫–∏–π unit-—Ç–µ—Å—Ç-–ø–ª–∞–Ω (—Ä—É—á–Ω–æ–π):

–ö–ª–∏–∫ –ø–æ –±–∞—Ä–∞–∫–∞–º ‚Üí –ø–∞–Ω–µ–ª—å –µ—Å—Ç—å ‚Üí –∫–ª–∏–∫ ¬´–ù–∞–Ω—è—Ç—å¬ª ‚Üí —Å–ø–∞–≤–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –ø–∞–Ω–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è.

–ö–ª–∏–∫ –ø–æ –ø–∞–ª–∏—Ç—Ä–µ (1/2/3) –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–∞–Ω–µ–ª–∏ ‚Üí –ø–∞–Ω–µ–ª—å –æ—Å—Ç–∞—ë—Ç—Å—è, —Ä–µ–∂–∏–º –º–µ–Ω—è–µ—Ç—Å—è.

–†–∞–º–∫–∞ –ø–æ —é–Ω–∏—Ç–∞–º ‚Üí –ø–∞–Ω–µ–ª—å —Å–∫—Ä—ã–ª–∞—Å—å.

–£—Å–ø–µ—à–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ ‚Üí –ø–∞–Ω–µ–ª—å —Å–∫—Ä—ã–ª–∞—Å—å.